
    <!DOCTYPE html>
    <html xmlns="http://www.w3.org/1999/xhtml">
    <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>The Flask Mega-Tutorial</title>
    <link href="style.css" rel="stylesheet" type="text/css" />
    </head>
    <div id="main">
 <div class="post">
  <p class="date">
   <span class="flask-moment" data-format="format('LL')" data-refresh="0" data-timestamp="2012-11-04T08:00:41Z">
    2012-11-04T08:00:41Z
   </span>
  </p>
  <h1 class="post-title">
   <a href="/post/the-flask-mega-tutorial-part-x-full-text-search">
    The Flask Mega-Tutorial, Part X: Full Text Search
   </a>
  </h1>
  <div class="post_body">
   <p>
    This is the tenth article in the series in which I document my experience writing web applications in
    <a href="http://python.org">
     Python
    </a>
    using the
    <a href="http://flask.pocoo.org">
     Flask
    </a>
    microframework.
   </p>
   <p>
    The goal of the tutorial series is to develop a decently featured microblogging application that demonstrating total lack of originality I have decided to call
    <code>
     microblog
    </code>
    .
   </p>
   <p>
    <strong>
     NOTE
    </strong>
    : This article was revised in September 2014 to be in sync with current versions of Python and Flask.
   </p>
   <p>
    Here is an index of all the articles in the series that have been published to date:
   </p>
   <ul>
    <li>
     <a href="the-flask-mega-tutorial-part-i-hello-world">
      Part I: Hello, World!
     </a>
    </li>
    <li>
     <a href="the-flask-mega-tutorial-part-ii-templates">
      Part II: Templates
     </a>
    </li>
    <li>
     <a href="the-flask-mega-tutorial-part-iii-web-forms">
      Part III: Web Forms
     </a>
    </li>
    <li>
     <a href="the-flask-mega-tutorial-part-iv-database">
      Part IV: Database
     </a>
    </li>
    <li>
     <a href="the-flask-mega-tutorial-part-v-user-logins">
      Part V: User Logins
     </a>
    </li>
    <li>
     <a href="the-flask-mega-tutorial-part-vi-profile-page-and-avatars">
      Part VI: Profile Page And Avatars
     </a>
    </li>
    <li>
     <a href="the-flask-mega-tutorial-part-vii-unit-testing">
      Part VII: Unit Testing
     </a>
    </li>
    <li>
     <a href="the-flask-mega-tutorial-part-viii-followers-contacts-and-friends">
      Part VIII: Followers, Contacts And Friends
     </a>
    </li>
    <li>
     <a href="the-flask-mega-tutorial-part-ix-pagination">
      Part IX: Pagination
     </a>
    </li>
    <li>
     <a href="the-flask-mega-tutorial-part-x-full-text-search">
      Part X: Full Text Search
     </a>
     (this article)
    </li>
    <li>
     <a href="the-flask-mega-tutorial-part-xi-email-support">
      Part XI: Email Support
     </a>
    </li>
    <li>
     <a href="the-flask-mega-tutorial-part-xii-facelift">
      Part XII: Facelift
     </a>
    </li>
    <li>
     <a href="the-flask-mega-tutorial-part-xiii-dates-and-times">
      Part XIII: Dates and Times
     </a>
    </li>
    <li>
     <a href="the-flask-mega-tutorial-part-xiv-i18n-and-l10n">
      Part XIV: I18n and L10n
     </a>
    </li>
    <li>
     <a href="the-flask-mega-tutorial-part-xv-ajax">
      Part XV: Ajax
     </a>
    </li>
    <li>
     <a href="the-flask-mega-tutorial-part-xvi-debugging-testing-and-profiling">
      Part XVI: Debugging, Testing and Profiling
     </a>
    </li>
    <li>
     <a href="the-flask-mega-tutorial-part-xvii-deployment-on-linux-even-on-the-raspberry-pi">
      Part XVII: Deployment on Linux (even on the Raspberry Pi!)
     </a>
    </li>
    <li>
     <a href="the-flask-mega-tutorial-part-xviii-deployment-on-the-heroku-cloud">
      Part XVIII: Deployment on the Heroku Cloud
     </a>
    </li>
   </ul>
   <h2>
    Recap
   </h2>
   <p>
    In the
    <a href="/post/the-flask-mega-tutorial-part-ix-pagination">
     previous article
    </a>
    in the series we've enhanced our database queries so that we can get results on pages.
   </p>
   <p>
    Today, we are going to continue working on our database, but in a different area. All applications that store content must provide a search capability.
   </p>
   <p>
    For many types of web sites it is possible to just let Google, Bing, etc. index all the content and provide the search results. This works well for sites that have mostly static pages, like a forum. In our little
    <code>
     microblog
    </code>
    application the basic unit of content is just a short user post, not a whole page. The type of search results that we want are dynamic. For example, if we search for the word "dog" we want to see blog posts from any users that include that word. It is obvious that until someone searches for that word there is no page that the big search engines could have indexed with these results, so clearly we have no choice other than rolling our own search.
   </p>
   <h2>
    Introduction to full text search engines
   </h2>
   <p>
    Unfortunately support for full text search in relational databases is not well standardized. Each database implements full text search in its own way, and SQLAlchemy at this time does not have a full text search abstration.
   </p>
   <p>
    We are currently using SQLite for our database, so we could just create a full text index using the facilities provided by SQLite, bypassing SQLAlchemy. But that isn't a good idea, because if one day we decide to switch to another database we would need to rewrite our full text search capability for another database.
   </p>
   <p>
    So instead, we are going to let our database deal with the regular data, and we are going to create a specialized database that will be dedicated to text searches.
   </p>
   <p>
    There are a few open source full text search engines. The only one that to my knowledge has a Flask extension is
    <a href="https://bitbucket.org/mchaput/whoosh/wiki/Home">
     Whoosh
    </a>
    , an engine also written in Python. The advantage of using a pure Python engine is that it will install and run anywhere a Python interpreter is available. The disadvantage is that search performance will not be up to par with other engines that are written in C or C++. In my opinion the ideal solution would be to have a Flask extension that can connect to several engines and abstract us from dealing with a particular one in the same way Flask-SQLAlchemy gives us the freedom to use several database engines, but nothing of that kind seems to be available for full text searching at this time. Django developers do have a very nice extension that supports several full text search engines called
    <a href="http://haystacksearch.org/">
     django-haystack
    </a>
    . Maybe one day someone will create a similar extension for Flask.
   </p>
   <p>
    But for now, we'll implement our text searching with Whoosh. The extension that we are going to use is
    <a href="http://packages.python.org/Flask-WhooshAlchemy">
     Flask-WhooshAlchemy
    </a>
    , which integrates a Whoosh database with Flask-SQLAlchemy models.
   </p>
   <h2>
    Python 3 Compatibility
   </h2>
   <p>
    Unfortunately, we have a problem with Python 3 and these packages. The Flask-WhooshAlchemy extension was never made compatible with Python 3. I have forked this extension and made a few changes to make it work, so if you are on Python 3 you will need to uninstall the official version and install my fork:
   </p>
   <pre><code>$ flask/bin/pip uninstall flask-whooshalchemy
$ flask/bin/pip install git+git://github.com/miguelgrinberg/flask-whooshalchemy.git
</code></pre>
   <p>
    Sadly this isn't the only problem. Whoosh also has issues with Python 3, it seems. In my testing I have encontered
    <a href="https://bitbucket.org/mchaput/whoosh/issue/395/ascii-codec-error-when-performing-query">
     this bug
    </a>
    , and to my knowledge there isn't a solution available, which means that at this time the full text search capability does not work well on Python 3. I will update this section once the issues are resolved.
   </p>
   <h2>
    Configuration
   </h2>
   <p>
    Configuration for Flask-WhooshAlchemy is pretty simple. We just need to tell the extension what is the name of the full text search database (file
    <code>
     config.py
    </code>
    ):
   </p>
   <pre><code>WHOOSH_BASE = os.path.join(basedir, 'search.db')
</code></pre>
   <h2>
    Model changes
   </h2>
   <p>
    Since Flask-WhooshAlchemy integrates with Flask-SQLAlchemy, we indicate what data is to be indexed for searching in the proper model class (file
    <code>
     app/models.py
    </code>
    ):
   </p>
   <pre><code>from app import app

import sys
if sys.version_info &gt;= (3, 0):
    enable_search = False
else:
    enable_search = True
    import flask.ext.whooshalchemy as whooshalchemy

class Post(db.Model):
    __searchable__ = ['body']

    id = db.Column(db.Integer, primary_key=True)
    body = db.Column(db.String(140))
    timestamp = db.Column(db.DateTime)
    user_id = db.Column(db.Integer, db.ForeignKey('user.id'))

    def __repr__(self):
        return '&lt;Post %r&gt;' % (self.body)

if enable_search:
    whooshalchemy.whoosh_index(app, Post)
</code></pre>
   <p>
    The model has a new
    <code>
     __searchable__
    </code>
    field, which is an array with all the database fields that will be in the searchable index. In our case we only want to index the body field of our posts.
   </p>
   <p>
    We also have to initialize the full text index for this model by calling the
    <code>
     whoosh_index
    </code>
    function. Note that since we know that the search capability currently does not work on Python 3 we have to skip its initialization. Once the problems in Whoosh are fixed the logic around
    <code>
     enable_search
    </code>
    can be removed.
   </p>
   <p>
    Since this isn't a change that affects the format of our relational database we do not need to record a new migration.
   </p>
   <p>
    Unfortunately any posts that were in the database before the full text engine was added will not be indexed. To make sure the database and the full text engine are synchronized we are going to delete all posts from the database and start over. First we start the Python interpreter. For Windows users:
   </p>
   <pre><code>flask\Scripts\python
</code></pre>
   <p>
    And for everyone else:
   </p>
   <pre><code>flask/bin/python
</code></pre>
   <p>
    Then in the Python prompt we delete all the posts:
   </p>
   <pre><code>&gt;&gt;&gt; from app.models import Post
&gt;&gt;&gt; from app import db
&gt;&gt;&gt; for post in Post.query.all():
...    db.session.delete(post)
&gt;&gt;&gt; db.session.commit()
</code></pre>
   <h2>
    Searching
   </h2>
   <p>
    And now we are ready to start searching. First let's add a few new posts to the database. We have two options to do this. We can just start the application and enter posts via the web browser, as regular users would do, or we can also do it in the Python prompt.
   </p>
   <p>
    From the Python prompt we can do it as follows:
   </p>
   <pre><code>&gt;&gt;&gt; from app.models import User, Post
&gt;&gt;&gt; from app import db
&gt;&gt;&gt; import datetime
&gt;&gt;&gt; u = User.query.get(1)
&gt;&gt;&gt; p = Post(body='my first post', timestamp=datetime.datetime.utcnow(), author=u)
&gt;&gt;&gt; db.session.add(p)
&gt;&gt;&gt; p = Post(body='my second post', timestamp=datetime.datetime.utcnow(), author=u)
&gt;&gt;&gt; db.session.add(p)
&gt;&gt;&gt; p = Post(body='my third and last post', timestamp=datetime.datetime.utcnow(), author=u)
&gt;&gt;&gt; db.session.add(p)
&gt;&gt;&gt; db.session.commit()
</code></pre>
   <p>
    The Flask-WhooshAlchemy extension is nice, because it hooks up into Flask-SQLAlchemy commits automatically. We do not need to maintain the full text index, it is all done for us transparently.
   </p>
   <p>
    Now that we have a few posts in our full text index we can issue searches:
   </p>
   <pre><code>&gt;&gt;&gt; Post.query.whoosh_search('post').all()
[&lt;Post u'my second post'&gt;, &lt;Post u'my first post'&gt;, &lt;Post u'my third and last post'&gt;]
&gt;&gt;&gt; Post.query.whoosh_search('second').all()
[&lt;Post u'my second post'&gt;]
&gt;&gt;&gt; Post.query.whoosh_search('second OR last').all()
[&lt;Post u'my second post'&gt;, &lt;Post u'my third and last post'&gt;]
</code></pre>
   <p>
    As you can see in the examples above, the queries do not need to be limited to single words. In fact, Whoosh supports a pretty powerful
    <a href="http://packages.python.org/Whoosh/querylang.html">
     search query language
    </a>
    .
   </p>
   <h2>
    Integrating full text searches into the application
   </h2>
   <p>
    To make the searching capability available to our application's users we have to add just a few small changes.
   </p>
   <h3>
    Configuration
   </h3>
   <p>
    As far as configuration, we'll just indicate how many search results should be returned as a maximum (file
    <code>
     config.py
    </code>
    ):
   </p>
   <pre><code>MAX_SEARCH_RESULTS = 50
</code></pre>
   <h3>
    Search form
   </h3>
   <p>
    We are going to add a search form to the navigation bar at the top of the page. Putting the search box at the top is nice, because then the search will be accessible from all pages.
   </p>
   <p>
    First we add a search form class (file
    <code>
     app/forms.py
    </code>
    ):
   </p>
   <pre><code>class SearchForm(Form):
    search = StringField('search', validators=[DataRequired()])
</code></pre>
   <p>
    Then we need to create a search form object and make it available to all templates, since we will be putting the search form in the navigation bar that is common to all pages. The easiest way to achieve this is to create the form in the
    <code>
     before_request
    </code>
    handler, and then stick it in Flask's global
    <code>
     g
    </code>
    (file
    <code>
     app/views.py
    </code>
    ):
   </p>
   <pre><code>from forms import SearchForm

@app.before_request
def before_request():
    g.user = current_user
    if g.user.is_authenticated:
        g.user.last_seen = datetime.utcnow()
        db.session.add(g.user)
        db.session.commit()
        g.search_form = SearchForm()
</code></pre>
   <p>
    Then we add the form to our template (file
    <code>
     app/templates/base.html
    </code>
    ):
   </p>
   <pre><code>&lt;div&gt;Microblog:
    &lt;a href="{{ url_for('index') }}"&gt;Home&lt;/a&gt;
    {% if g.user.is_authenticated %}
    | &lt;a href="{{ url_for('user', nickname=g.user.nickname) }}"&gt;Your Profile&lt;/a&gt;
    | &lt;form style="display: inline;" action="{{ url_for('search') }}" method="post" name="search"&gt;{{ g.search_form.hidden_tag() }}{{ g.search_form.search(size=20) }}&lt;input type="submit" value="Search"&gt;&lt;/form&gt;
    | &lt;a href="{{ url_for('logout') }}"&gt;Logout&lt;/a&gt;
    {% endif %}
&lt;/div&gt;
</code></pre>
   <p>
    Note that we only display the form when we have a logged in user. Likewise, the
    <code>
     before_request
    </code>
    handler will only create a form when a user is logged in, since our application does not show any content to guests that are not authenticated.
   </p>
   <h3>
    Search view function
   </h3>
   <p>
    The
    <code>
     action
    </code>
    field of our form was set above to send all search requests the the
    <code>
     search
    </code>
    view function. This is where we will be issuing our full text queries (file
    <code>
     app/views.py
    </code>
    ):
   </p>
   <pre><code>@app.route('/search', methods=['POST'])
@login_required
def search():
    if not g.search_form.validate_on_submit():
        return redirect(url_for('index'))
    return redirect(url_for('search_results', query=g.search_form.search.data))
</code></pre>
   <p>
    This function doesn't really do much, it just collects the search query from the form and then redirects to another page passing this query as an argument. The reason the search work isn't done directly here is that if a user then hits the refresh button the browser will put up a warning indicating that form data will be resubmitted. This is avoided when the response to a POST request is a redirect, because after the redirect the browser's refresh button will reload the redirected page.
   </p>
   <h2>
    Search results page
   </h2>
   <p>
    Once a query string has been received the form POST handler sends it via page redirection to the
    <code>
     search_results
    </code>
    handler (file
    <code>
     app/views.py
    </code>
    ):
   </p>
   <pre><code>from config import MAX_SEARCH_RESULTS

@app.route('/search_results/&lt;query&gt;')
@login_required
def search_results(query):
    results = Post.query.whoosh_search(query, MAX_SEARCH_RESULTS).all()
    return render_template('search_results.html',
                           query=query,
                           results=results)
</code></pre>
   <p>
    The search results view function sends the query into Whoosh, passing a maximum number of search results, since we don't want to be presenting a potentially large number of hits, we are happy showing just the first fifty.
   </p>
   <p>
    The final piece is the search results template (file
    <code>
     app/templates/search_results.html
    </code>
    ):
   </p>
   <pre><code>&lt;!-- extend base layout --&gt;
{% extends "base.html" %}

{% block content %}
  &lt;h1&gt;Search results for "{{ query }}":&lt;/h1&gt;
  {% for post in results %}
      {% include 'post.html' %}
  {% endfor %}
{% endblock %}
</code></pre>
   <p>
    And here, once again, we can reuse our
    <code>
     post.html
    </code>
    sub-template, so we don't need to worry about rendering avatars or other formatting elements, since all of that is done in a generic way in the sub-template.
   </p>
   <h2>
    Final words
   </h2>
   <p>
    We now have completed yet another important, though often overlooked piece that any decent web application must have.
   </p>
   <p>
    The source code for the updated
    <code>
     microblog
    </code>
    application is available below:
   </p>
   <p>
    Download
    <a href="https://github.com/miguelgrinberg/microblog/archive/version-0.10.zip">
     microblog-0.10.zip
    </a>
    .
   </p>
   <p>
    As always, the above download does not include a database or a flask virtual environment. See previous articles in the series to learn how to create these.
   </p>
   <p>
    I hope you enjoyed this tutorial. If you have any questions feel free to write in the comments below. Thank you for reading, and I will be seeing you again in the next installment!
   </p>
   <p>
    Miguel
   </p>
  </div>
  <div class="social-bar">
   <table>
    <tr>
     <td>
      <div class="social-box" style="padding-top: 8px;">
       <a class="twitter-share-button" data-count="vertical" data-url="http://blog.miguelgrinberg.com/post/the-flask-mega-tutorial-part-x-full-text-search" data-via="miguelgrinberg" href="https://twitter.com/share">
        Tweet
       </a>
      </div>
     </td>
     <td>
      <div class="social-box" style="padding-left: 6px;">
       <div class="fb-like" data-font="verdana" data-href="http://blog.miguelgrinberg.com/post/the-flask-mega-tutorial-part-x-full-text-search" data-layout="box_count" data-send="false" data-show-faces="false" data-width="450">
       </div>
      </div>
     </td>
     <td>
      <div class="social-box" style="padding-top: 8px;">
       <g:plusone href="http://blog.miguelgrinberg.com/post/the-flask-mega-tutorial-part-x-full-text-search" size="tall">
       </g:plusone>
      </div>
     </td>
     <td>
      <div class="social-box" style="padding-top: 8px;">
       <script data-counter="top" data-url="http://blog.miguelgrinberg.com/post/the-flask-mega-tutorial-part-x-full-text-search" type="IN/Share">
       </script>
      </div>
     </td>
    </tr>
   </table>
  </div>
  <h4 style="text-align: right">
   <a name="comments">
   </a>
   101 comments
  </h4>
  <div class="comment">
   <ul>
    <li>
     <div class="comment-thumbnail">
      <img src="http://gravatar.com/avatar/c77668f5dc99964705088378af2ae073?s=60&amp;d=identicon"/>
     </div>
     <div class="comment-body">
      <p>
       <span class="label label-default">
        #1
       </span>
       <span class="label label-primary">
        neoragex
       </span>
       said
       <span class="flask-moment" data-format="fromNow(0)" data-refresh="0" data-timestamp="2012-12-08T01:49:40Z">
        2012-12-08T01:49:40Z
       </span>
      </p>
      <div style="overflow: auto;">
       <p style="white-space: pre-wrap;">
        Thank you for the excellent tutorials. Keep up the good work Miguel.

And also obligatory here (only one chance to do it)...

Furst!!!!!!!!!11 :)
       </p>
      </div>
     </div>
    </li>
    <li>
     <div class="comment-thumbnail">
      <img src="http://gravatar.com/avatar/e73f24fd349330df1b82bb810a4b61b8?s=60&amp;d=identicon"/>
     </div>
     <div class="comment-body">
      <p>
       <span class="label label-default">
        #2
       </span>
       <span class="label label-primary">
        Vadim
       </span>
       said
       <span class="flask-moment" data-format="fromNow(0)" data-refresh="0" data-timestamp="2013-01-03T15:41:11Z">
        2013-01-03T15:41:11Z
       </span>
      </p>
      <div style="overflow: auto;">
       <p style="white-space: pre-wrap;">
        In model Post misprint:
'return '&lt;Post %r&gt;' % (self.text)'
Must be:
'return '&lt;Post %r&gt;' % (self.body)'
       </p>
      </div>
     </div>
    </li>
    <li>
     <div class="comment-thumbnail">
      <img src="http://gravatar.com/avatar/729e26a2a2c7ff24a71958d4aa4e5f35?s=60&amp;d=identicon"/>
     </div>
     <div class="comment-body">
      <p>
       <span class="label label-default">
        #3
       </span>
       <span class="label label-danger">
        Miguel Grinberg
       </span>
       said
       <span class="flask-moment" data-format="fromNow(0)" data-refresh="0" data-timestamp="2013-01-03T22:37:09Z">
        2013-01-03T22:37:09Z
       </span>
      </p>
      <div style="overflow: auto;">
       <p style="white-space: pre-wrap;">
        @Vadim: you are correct, thanks for pointing it out. I have corrected the code above.
       </p>
      </div>
     </div>
    </li>
    <li>
     <div class="comment-thumbnail">
      <img src="http://gravatar.com/avatar/2c02c167f88ee80d03aa6d3b489ca935?s=60&amp;d=identicon"/>
     </div>
     <div class="comment-body">
      <p>
       <span class="label label-default">
        #4
       </span>
       <span class="label label-primary">
        George Mabley
       </span>
       said
       <span class="flask-moment" data-format="fromNow(0)" data-refresh="0" data-timestamp="2013-02-15T03:32:02Z">
        2013-02-15T03:32:02Z
       </span>
      </p>
      <div style="overflow: auto;">
       <p style="white-space: pre-wrap;">
        I feel like a pest asking all of these questions, but I can't seem to find any information about this error.  Previously I added a feature to delete posts with a view that finds the post through its id, then removes it with db.session.delete().  However, after adding search, calling that view function gives the error: InvalidRequestError: Object '&lt;Post at 0x3fe04a8&gt;' is already attached to session '1' (this is '5').  Have you ever experienced a problem similar to this?   Is there a way to bring the object to the current session?  Thanks for helping so much!
       </p>
      </div>
     </div>
    </li>
    <li>
     <div class="comment-thumbnail">
      <img src="http://gravatar.com/avatar/729e26a2a2c7ff24a71958d4aa4e5f35?s=60&amp;d=identicon"/>
     </div>
     <div class="comment-body">
      <p>
       <span class="label label-default">
        #5
       </span>
       <span class="label label-danger">
        Miguel Grinberg
       </span>
       said
       <span class="flask-moment" data-format="fromNow(0)" data-refresh="0" data-timestamp="2013-02-15T05:26:42Z">
        2013-02-15T05:26:42Z
       </span>
      </p>
      <div style="overflow: auto;">
       <p style="white-space: pre-wrap;">
        George, are you using the development server like I am or do you have a different web server? All the references I see for this error are for multithreaded servers, the error occurs when the same object is attached to two sessions at the same time. Note that due to the way the application is at this stage you are likely to encounter race conditions with a multithreaded server, there is no proper locking to prevent two threads from modifying the same record and colliding.
       </p>
      </div>
     </div>
    </li>
    <li>
     <div class="comment-thumbnail">
      <img src="http://gravatar.com/avatar/2c02c167f88ee80d03aa6d3b489ca935?s=60&amp;d=identicon"/>
     </div>
     <div class="comment-body">
      <p>
       <span class="label label-default">
        #6
       </span>
       <span class="label label-primary">
        George Mabley
       </span>
       said
       <span class="flask-moment" data-format="fromNow(0)" data-refresh="0" data-timestamp="2013-02-16T02:58:57Z">
        2013-02-16T02:58:57Z
       </span>
      </p>
      <div style="overflow: auto;">
       <p style="white-space: pre-wrap;">
        I am using basically the same setup that you are, just with a few added views and model tweaks.  I was able to delete before adding search, and can also comment out the __searchable__ and whoosh_index lines to get my delete function to work.  Should I just read up on ways to lock the sessions, or is it unrealistic with the way the site is set up currently?
       </p>
      </div>
     </div>
    </li>
    <li>
     <div class="comment-thumbnail">
      <img src="http://gravatar.com/avatar/729e26a2a2c7ff24a71958d4aa4e5f35?s=60&amp;d=identicon"/>
     </div>
     <div class="comment-body">
      <p>
       <span class="label label-default">
        #7
       </span>
       <span class="label label-danger">
        Miguel Grinberg
       </span>
       said
       <span class="flask-moment" data-format="fromNow(0)" data-refresh="0" data-timestamp="2013-02-16T04:47:08Z">
        2013-02-16T04:47:08Z
       </span>
      </p>
      <div style="overflow: auto;">
       <p style="white-space: pre-wrap;">
        @George: can you show me the code that you have written, in particular the delete post view function and the changes to the Post model? You paste the code on pastebin or similar and share the URL here. Thanks!
       </p>
      </div>
     </div>
    </li>
    <li>
     <div class="comment-thumbnail">
      <img src="http://gravatar.com/avatar/2c02c167f88ee80d03aa6d3b489ca935?s=60&amp;d=identicon"/>
     </div>
     <div class="comment-body">
      <p>
       <span class="label label-default">
        #8
       </span>
       <span class="label label-primary">
        George Mabley
       </span>
       said
       <span class="flask-moment" data-format="fromNow(0)" data-refresh="0" data-timestamp="2013-02-17T20:09:06Z">
        2013-02-17T20:09:06Z
       </span>
      </p>
      <div style="overflow: auto;">
       <p style="white-space: pre-wrap;">
        Sorry for the delayed response.  Here are the two parts of the code.
http://pastebin.com/0TDx8Gz8
       </p>
      </div>
     </div>
    </li>
    <li>
     <div class="comment-thumbnail">
      <img src="http://gravatar.com/avatar/2c02c167f88ee80d03aa6d3b489ca935?s=60&amp;d=identicon"/>
     </div>
     <div class="comment-body">
      <p>
       <span class="label label-default">
        #9
       </span>
       <span class="label label-primary">
        George Mabley
       </span>
       said
       <span class="flask-moment" data-format="fromNow(0)" data-refresh="0" data-timestamp="2013-02-17T20:13:43Z">
        2013-02-17T20:13:43Z
       </span>
      </p>
      <div style="overflow: auto;">
       <p style="white-space: pre-wrap;">
        While adjusting for clarity on pastebin, I forgot to change the delete(u) to delete(post), but that is not the problem with the code. My bad!
       </p>
      </div>
     </div>
    </li>
    <li>
     <div class="comment-thumbnail">
      <img src="http://gravatar.com/avatar/729e26a2a2c7ff24a71958d4aa4e5f35?s=60&amp;d=identicon"/>
     </div>
     <div class="comment-body">
      <p>
       <span class="label label-default">
        #10
       </span>
       <span class="label label-danger">
        Miguel Grinberg
       </span>
       said
       <span class="flask-moment" data-format="fromNow(0)" data-refresh="0" data-timestamp="2013-02-18T06:27:32Z">
        2013-02-18T06:27:32Z
       </span>
      </p>
      <div style="overflow: auto;">
       <p style="white-space: pre-wrap;">
        @George: I get the error too. I haven't figured out exactly where the problem is, but after some debugging I noticed there is more than one session object active. As a workaround you can add 'db.session.close_all()` before the db.session.delete() call and that removes those extra sessions. I'll continue debugging to try to figure out where those extra sessions come from.
       </p>
      </div>
     </div>
    </li>
    <li>
     <div class="comment-thumbnail">
      <img src="http://gravatar.com/avatar/729e26a2a2c7ff24a71958d4aa4e5f35?s=60&amp;d=identicon"/>
     </div>
     <div class="comment-body">
      <p>
       <span class="label label-default">
        #11
       </span>
       <span class="label label-danger">
        Miguel Grinberg
       </span>
       said
       <span class="flask-moment" data-format="fromNow(0)" data-refresh="0" data-timestamp="2013-02-19T03:59:38Z">
        2013-02-19T03:59:38Z
       </span>
      </p>
      <div style="overflow: auto;">
       <p style="white-space: pre-wrap;">
        There is a bug in Flask-WhooshAlchemy that is causing this. I have forked the project and fixed it at https://github.com/miguelgrinberg/Flask-WhooshAlchemy. Hopefully the author will apply this fix or something similar soon. In the meantime you can download my fixed version and install it manually over the original. I will explain the bug and how I found it in an upcoming debugging article, not the following one but probably the one after that.
       </p>
      </div>
     </div>
    </li>
    <li>
     <div class="comment-thumbnail">
      <img src="http://gravatar.com/avatar/0721f97198357afcef36a69f4c3f6f97?s=60&amp;d=identicon"/>
     </div>
     <div class="comment-body">
      <p>
       <span class="label label-default">
        #12
       </span>
       <span class="label label-primary">
        Richard Austin
       </span>
       said
       <span class="flask-moment" data-format="fromNow(0)" data-refresh="0" data-timestamp="2013-04-01T02:10:35Z">
        2013-04-01T02:10:35Z
       </span>
      </p>
      <div style="overflow: auto;">
       <p style="white-space: pre-wrap;">
        Thank you for this great set of tutorials. I tried flask a while back, but got stuck trying to implement various features, including search. So this was very helpful! One small note though: This page is missing a couple of import statements (SearchForm &amp; MAX_SEARCH_RESULTS). Nothing serious!
       </p>
      </div>
     </div>
    </li>
    <li>
     <div class="comment-thumbnail">
      <img src="http://gravatar.com/avatar/729e26a2a2c7ff24a71958d4aa4e5f35?s=60&amp;d=identicon"/>
     </div>
     <div class="comment-body">
      <p>
       <span class="label label-default">
        #13
       </span>
       <span class="label label-danger">
        Miguel Grinberg
       </span>
       said
       <span class="flask-moment" data-format="fromNow(0)" data-refresh="0" data-timestamp="2013-04-01T03:12:29Z">
        2013-04-01T03:12:29Z
       </span>
      </p>
      <div style="overflow: auto;">
       <p style="white-space: pre-wrap;">
        @Richard: thanks, I have added the missing imports.
       </p>
      </div>
     </div>
    </li>
    <li>
     <div class="comment-thumbnail">
      <img src="http://gravatar.com/avatar/154f1eafc30ac035dc0fc9c12cc26512?s=60&amp;d=identicon"/>
     </div>
     <div class="comment-body">
      <p>
       <span class="label label-default">
        #14
       </span>
       <span class="label label-primary">
        James
       </span>
       said
       <span class="flask-moment" data-format="fromNow(0)" data-refresh="0" data-timestamp="2013-04-23T20:05:49Z">
        2013-04-23T20:05:49Z
       </span>
      </p>
      <div style="overflow: auto;">
       <p style="white-space: pre-wrap;">
        Since this version the unit test 'test_follow_posts' isn't working anymore. I've downloaded microblog-0.10.zip. and ensured the test is included in tests.py.

Any ideas?
       </p>
      </div>
     </div>
    </li>
    <li>
     <div class="comment-thumbnail">
      <img src="http://gravatar.com/avatar/154f1eafc30ac035dc0fc9c12cc26512?s=60&amp;d=identicon"/>
     </div>
     <div class="comment-body">
      <p>
       <span class="label label-default">
        #15
       </span>
       <span class="label label-primary">
        James
       </span>
       said
       <span class="flask-moment" data-format="fromNow(0)" data-refresh="0" data-timestamp="2013-04-23T20:10:40Z">
        2013-04-23T20:10:40Z
       </span>
      </p>
      <div style="overflow: auto;">
       <p style="white-space: pre-wrap;">
        If I comment out the following lines the test is working again:
#    __searchable__ = ['body']
....
#whooshalchemy.whoosh_index(app, Post)
       </p>
      </div>
     </div>
    </li>
    <li>
     <div class="comment-thumbnail">
      <img src="http://gravatar.com/avatar/154f1eafc30ac035dc0fc9c12cc26512?s=60&amp;d=identicon"/>
     </div>
     <div class="comment-body">
      <p>
       <span class="label label-default">
        #16
       </span>
       <span class="label label-primary">
        James
       </span>
       said
       <span class="flask-moment" data-format="fromNow(0)" data-refresh="0" data-timestamp="2013-04-23T20:58:27Z">
        2013-04-23T20:58:27Z
       </span>
      </p>
      <div style="overflow: auto;">
       <p style="white-space: pre-wrap;">
        You can ignore my previous comments. After the flask-whooshalchemy fix mentioned in Part XVI the unit test is working.
       </p>
      </div>
     </div>
    </li>
    <li>
     <div class="comment-thumbnail">
      <img src="http://gravatar.com/avatar/b894ece10020b459f60f1f7d03c9c925?s=60&amp;d=identicon"/>
     </div>
     <div class="comment-body">
      <p>
       <span class="label label-default">
        #17
       </span>
       <span class="label label-primary">
        Guillermo Nuñez
       </span>
       said
       <span class="flask-moment" data-format="fromNow(0)" data-refresh="0" data-timestamp="2013-08-25T20:58:42Z">
        2013-08-25T20:58:42Z
       </span>
      </p>
      <div style="overflow: auto;">
       <p style="white-space: pre-wrap;">
        This is exactly what I was looking for a couple of my projects. 
But on one of them, the site has already been running for almost a year. Is it possible to make it work with existing data?
       </p>
      </div>
     </div>
    </li>
    <li>
     <div class="comment-thumbnail">
      <img src="http://gravatar.com/avatar/729e26a2a2c7ff24a71958d4aa4e5f35?s=60&amp;d=identicon"/>
     </div>
     <div class="comment-body">
      <p>
       <span class="label label-default">
        #18
       </span>
       <span class="label label-danger">
        Miguel Grinberg
       </span>
       said
       <span class="flask-moment" data-format="fromNow(0)" data-refresh="0" data-timestamp="2013-08-26T02:17:52Z">
        2013-08-26T02:17:52Z
       </span>
      </p>
      <div style="overflow: auto;">
       <p style="white-space: pre-wrap;">
        @Guillermo: there are utilities that can look at a database and generate compatible SQLAlchemy models. Search for SQLSoup and sqlautocode, for example.
       </p>
      </div>
     </div>
    </li>
    <li>
     <div class="comment-thumbnail">
      <img src="http://gravatar.com/avatar/31f80349a81989ad1f6d718dbd86cc3d?s=60&amp;d=identicon"/>
     </div>
     <div class="comment-body">
      <p>
       <span class="label label-default">
        #19
       </span>
       <span class="label label-primary">
        Gurom
       </span>
       said
       <span class="flask-moment" data-format="fromNow(0)" data-refresh="0" data-timestamp="2013-11-21T19:12:52Z">
        2013-11-21T19:12:52Z
       </span>
      </p>
      <div style="overflow: auto;">
       <p style="white-space: pre-wrap;">
        Dear Miguel Grinberg!

One more time :)  Many thanks for your greate job!

I have a problem after lesson "Part X: Full Text Search ". Please look at the following error:
________________________
File "......./app/views.py", line 44, in index
Display the sourcecode for this frameOpen an interactive python shell in this frameposts = g.user.followed_posts().paginate(page, POSTS_PER_PAGE, False)
AttributeError: '_QueryProxy' object has no attribute 'paginate'
________________________
This mistake happens after your code (microblog-0.10.zip.) too. Do you have any idea were is problem?
       </p>
      </div>
     </div>
    </li>
    <li>
     <div class="comment-thumbnail">
      <img src="http://gravatar.com/avatar/729e26a2a2c7ff24a71958d4aa4e5f35?s=60&amp;d=identicon"/>
     </div>
     <div class="comment-body">
      <p>
       <span class="label label-default">
        #20
       </span>
       <span class="label label-danger">
        Miguel Grinberg
       </span>
       said
       <span class="flask-moment" data-format="fromNow(0)" data-refresh="0" data-timestamp="2013-11-21T19:19:31Z">
        2013-11-21T19:19:31Z
       </span>
      </p>
      <div style="overflow: auto;">
       <p style="white-space: pre-wrap;">
        @Gurom: install my fork of the Flask-WhooshAlchemy project, the official version has a bug that causes that error.
       </p>
      </div>
     </div>
    </li>
    <li>
     <div class="comment-thumbnail">
      <img src="http://gravatar.com/avatar/0952c4a2c08421aecb397d3a81545f6e?s=60&amp;d=identicon"/>
     </div>
     <div class="comment-body">
      <p>
       <span class="label label-default">
        #21
       </span>
       <span class="label label-primary">
        Joshua Grigonis
       </span>
       said
       <span class="flask-moment" data-format="fromNow(0)" data-refresh="0" data-timestamp="2013-12-16T19:42:23Z">
        2013-12-16T19:42:23Z
       </span>
      </p>
      <div style="overflow: auto;">
       <p style="white-space: pre-wrap;">
        Downloading/unpacking Flask-WhooshAlchemy
  Could not find a version that satisfies the requirement Flask-WhooshAlchemy (from versions: 0.3a.macosx-10.6-x86_64, 0
.1a, 0.2a, 0.4a, 0.51a, 0.53a, 0.54a, 0.55a, 0.5a, v0.52a)
Cleaning up...
No distributions matching the version for Flask-WhooshAlchemy
Storing complete log in C:\Users\joshua.grigonis\pip\pip.log
       </p>
      </div>
     </div>
    </li>
    <li>
     <div class="comment-thumbnail">
      <img src="http://gravatar.com/avatar/0952c4a2c08421aecb397d3a81545f6e?s=60&amp;d=identicon"/>
     </div>
     <div class="comment-body">
      <p>
       <span class="label label-default">
        #22
       </span>
       <span class="label label-primary">
        Joshua Grigonis
       </span>
       said
       <span class="flask-moment" data-format="fromNow(0)" data-refresh="0" data-timestamp="2013-12-16T23:42:34Z">
        2013-12-16T23:42:34Z
       </span>
      </p>
      <div style="overflow: auto;">
       <p style="white-space: pre-wrap;">
        I was able to install WhooshAlchemy from git.
       </p>
      </div>
     </div>
    </li>
    <li>
     <div class="comment-thumbnail">
      <img src="http://gravatar.com/avatar/de134ce047a799e1f2799215a82460da?s=60&amp;d=identicon"/>
     </div>
     <div class="comment-body">
      <p>
       <span class="label label-default">
        #23
       </span>
       <span class="label label-primary">
        Farshid P.
       </span>
       said
       <span class="flask-moment" data-format="fromNow(0)" data-refresh="0" data-timestamp="2013-12-27T10:23:48Z">
        2013-12-27T10:23:48Z
       </span>
      </p>
      <div style="overflow: auto;">
       <p style="white-space: pre-wrap;">
        How do you install from git ? I downloaded Miguel's version, and clearly see the difference in the code he has made.

Do I just move the flask_whooshalchemy.py to the site-packages and replace ? Or do I move the the whole folder and run the setup.py ?
       </p>
      </div>
     </div>
    </li>
    <li>
     <div class="comment-thumbnail">
      <img src="http://gravatar.com/avatar/de134ce047a799e1f2799215a82460da?s=60&amp;d=identicon"/>
     </div>
     <div class="comment-body">
      <p>
       <span class="label label-default">
        #24
       </span>
       <span class="label label-primary">
        Farshid P.
       </span>
       said
       <span class="flask-moment" data-format="fromNow(0)" data-refresh="0" data-timestamp="2013-12-27T11:29:53Z">
        2013-12-27T11:29:53Z
       </span>
      </p>
      <div style="overflow: auto;">
       <p style="white-space: pre-wrap;">
        Figured out how to 'install' the edited Whoosh fork from Miguel's github ( https://github.com/miguelgrinberg/Flask-WhooshAlchemy )that fixes the _QueryProxy bug.

Just copy and past the Flask_WhooshAlchemy.py in the site-packages folder under flask/lib directory and run it (python Flask_WhooshAlchemy.py).

Shazam fixed the bug.
       </p>
      </div>
     </div>
    </li>
    <li>
     <div class="comment-thumbnail">
      <img src="http://gravatar.com/avatar/59d6b2ae9b8c9a808658d8ea75fec4d7?s=60&amp;d=identicon"/>
     </div>
     <div class="comment-body">
      <p>
       <span class="label label-default">
        #25
       </span>
       <span class="label label-primary">
        <a href="corygough.com">
         Cory Gough
        </a>
       </span>
       said
       <span class="flask-moment" data-format="fromNow(0)" data-refresh="0" data-timestamp="2014-01-07T00:52:16Z">
        2014-01-07T00:52:16Z
       </span>
      </p>
      <div style="overflow: auto;">
       <p style="white-space: pre-wrap;">
        The lessons are great! But for some reason I am having trouble with pagination.  It actually didn't give me this error until I made the text search changes, but now I am getting the below exception.  I even download your code base and it is giving me the same issue.  Do you have any idea why?  As alway thank you for your help!

    File "/home/cory/Documents/microblog-0.10/app/views.py", line 43, in index

    posts = g.user.followed_posts().paginate(page, POSTS_PER_PAGE, False)

    AttributeError: '_QueryProxy' object has no attribute 'paginate'
       </p>
      </div>
     </div>
    </li>
   </ul>
  </div>
  <div class="page">
   <ul class="pager">
    <li class="previous disabled">
     <a href="#">
      ««
     </a>
    </li>
    <li class="previous disabled">
     <a href="#">
      «
     </a>
    </li>
    <li class="next">
     <a href="/post/the-flask-mega-tutorial-part-x-full-text-search/page/0#comments">
      »»
     </a>
    </li>
    <li class="next">
     <a href="/post/the-flask-mega-tutorial-part-x-full-text-search/page/2#comments">
      »
     </a>
    </li>
   </ul>
  </div>
  <h3>
   <a name="commentform">
   </a>
   Leave a Comment
  </h3>
  <form action="#commentform" class="form" method="post" role="form">
   <div style="display:none;">
    <input id="csrf_token" name="csrf_token" type="hidden" value="1452908231.26##4db0b9c8a45e9625171318dbf5e5339b7bca1456"/>
   </div>
   <div class="form-group ">
    <label class="control-label" for="name">
     Name
    </label>
    <input class="form-control" id="name" name="name" required="" type="text" value=""/>
   </div>
   <div class="form-group ">
    <label class="control-label" for="url">
     URL
    </label>
    <input class="form-control" id="url" name="url" type="text" value=""/>
   </div>
   <div class="form-group ">
    <label class="control-label" for="email">
     Email
    </label>
    <input class="form-control" id="email" name="email" required="" type="text" value=""/>
   </div>
   <div class="form-group ">
    <label class="control-label" for="comment">
     Comment
    </label>
    <textarea class="form-control" id="comment" name="comment" required="">
    </textarea>
   </div>
   <div class="form-group ">
    <label class="control-label" for="captcha">
     Captcha
    </label>
    <script type="text/javascript">
     var RecaptchaOptions = {"custom_translations": {"audio_challenge": "Get an audio challenge", "cant_hear_this": "Download sound as MP3", "help_btn": "Help", "image_alt_text": "reCAPTCHA challenge image", "incorrect_try_again": "Incorrect. Try again.", "instructions_audio": "Type what you hear", "instructions_visual": "Type the text", "play_again": "Play sound again", "privacy_and_terms": "Privacy & Terms", "refresh_btn": "Get a new challenge", "visual_challenge": "Get a visual challenge"}, "theme": "white"};
    </script>
    <script src="//www.google.com/recaptcha/api/challenge?k=6Ld5Zs4SAAAAAOY0DOi4r18bgHlEaz41qAoRf__S" type="text/javascript">
    </script>
    <noscript>
     <iframe frameborder="0" height="300" src="//www.google.com/recaptcha/api/noscript?k=6Ld5Zs4SAAAAAOY0DOi4r18bgHlEaz41qAoRf__S" width="500">
     </iframe>
     <br/>
     <textarea cols="40" name="recaptcha_challenge_field" rows="3">
     </textarea>
     <input name="recaptcha_response_field" type="hidden" value="manual_challenge"/>
    </noscript>
   </div>
   <input class="btn btn-default" id="submit" name="submit" type="submit" value="Submit"/>
  </form>
 </div>
</div>

    </html>
    